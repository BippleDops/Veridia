<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cordelia Vault - Live Session</title>
    <style>
        :root {
            --primary-dark: #0a1628;
            --secondary-dark: #1e3a5f;
            --accent-teal: #4fd1c7;
            --accent-coral: #ff7f5c;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }

        .session-layout {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 1px;
            background: rgba(79, 209, 199, 0.1);
        }

        .session-header {
            grid-column: 1 / -1;
            background: rgba(30, 58, 95, 0.8);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(79, 209, 199, 0.2);
        }

        .session-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-teal);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-connected { background: var(--success); }
        .status-disconnected { background: var(--danger); }
        .status-connecting { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .users-panel {
            background: rgba(30, 58, 95, 0.5);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-teal);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(79, 209, 199, 0.2);
        }

        .user-item {
            background: rgba(10, 22, 40, 0.6);
            border: 1px solid rgba(79, 209, 199, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            border-color: var(--accent-teal);
            background: rgba(79, 209, 199, 0.1);
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .user-details {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .user-activity {
            font-size: 0.7rem;
            color: var(--accent-teal);
            margin-top: 4px;
            font-style: italic;
        }

        .role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .role-gm { background: var(--accent-coral); color: white; }
        .role-player { background: var(--accent-teal); color: var(--primary-dark); }
        .role-observer { background: var(--text-muted); color: var(--primary-dark); }

        .main-content {
            background: rgba(30, 58, 95, 0.3);
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .activity-feed {
            background: rgba(30, 58, 95, 0.5);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .activity-item {
            background: rgba(10, 22, 40, 0.6);
            border: 1px solid rgba(79, 209, 199, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 0.7rem;
            float: right;
        }

        .activity-type {
            font-weight: bold;
            color: var(--accent-teal);
            margin-bottom: 2px;
        }

        .activity-user {
            color: var(--accent-coral);
            font-weight: 500;
        }

        .event-file_changed { border-left: 3px solid var(--warning); }
        .event-user_activity { border-left: 3px solid var(--accent-teal); }
        .event-message { border-left: 3px solid var(--success); }
        .event-user_joined { border-left: 3px solid var(--success); }
        .event-user_left { border-left: 3px solid var(--danger); }

        .connect-form {
            background: rgba(10, 22, 40, 0.8);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            text-align: center;
        }

        .connect-form h2 {
            color: var(--accent-teal);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 6px;
            background: rgba(10, 22, 40, 0.5);
            color: var(--text-light);
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 2px rgba(79, 209, 199, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-teal), #38b2ac);
            color: var(--primary-dark);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 15px rgba(79, 209, 199, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .message-input {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(79, 209, 199, 0.2);
        }

        .message-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 6px;
            background: rgba(10, 22, 40, 0.5);
            color: var(--text-light);
        }

        .message-input button {
            padding: 8px 15px;
        }

        .content-sync-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 22, 40, 0.8);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            color: var(--accent-teal);
        }

        .file-changes {
            background: rgba(255, 127, 92, 0.1);
            border: 1px solid var(--accent-coral);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .file-changes h4 {
            color: var(--accent-coral);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .changed-file {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .loading {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        .cursor-indicator {
            position: absolute;
            width: 2px;
            height: 20px;
            background: var(--accent-coral);
            animation: blink 1s infinite;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .selection-highlight {
            background: rgba(79, 209, 199, 0.2);
            border-radius: 2px;
            pointer-events: none;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 22, 40, 0.9);
            border: 1px solid var(--accent-teal);
            border-radius: 6px;
            padding: 12px 16px;
            color: var(--text-light);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .stats-bar {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div id="connectForm" class="connect-form">
        <h2>üî¥ Join Live Session</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">
            Connect to the Cordelia Vault collaborative session to see real-time updates and coordinate with other players.
        </p>
        
        <form id="connectionForm">
            <div class="form-group">
                <label for="userId">Username</label>
                <input type="text" id="userId" required placeholder="Enter your username">
            </div>
            
            <div class="form-group">
                <label for="displayName">Display Name</label>
                <input type="text" id="displayName" required placeholder="Your display name">
            </div>
            
            <div class="form-group">
                <label for="userRole">Role</label>
                <select id="userRole" required>
                    <option value="">Select your role</option>
                    <option value="GM">Game Master</option>
                    <option value="Player">Player</option>
                    <option value="Observer">Observer</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">üîó Connect to Session</button>
        </form>
    </div>

    <div id="sessionInterface" class="session-layout hidden">
        <div class="session-header">
            <div class="session-title">üî¥ Live Session - Cordelia Vault</div>
            <div class="connection-status">
                <span class="status-indicator" id="connectionIndicator"></span>
                <span id="connectionText">Connecting...</span>
                <div class="stats-bar">
                    <span>Users: <span id="userCount">0</span></span>
                    <span>Events: <span id="eventCount">0</span></span>
                    <span id="serverTime"></span>
                </div>
                <button class="btn btn-danger btn-small" onclick="disconnect()">Disconnect</button>
            </div>
        </div>

        <div class="users-panel">
            <div class="panel-title">üë• Connected Users</div>
            <div id="usersList" class="loading">Loading users...</div>
        </div>

        <div class="main-content">
            <div class="content-sync-indicator">
                üì° <span id="syncStatus">Synchronized</span>
            </div>
            
            <h2>Session Content</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">
                This area would show the current session content, synchronized across all participants.
                File changes and user activities are tracked in real-time.
            </p>

            <div id="fileChanges" style="display: none;">
                <div class="file-changes">
                    <h4>üìù Recent File Changes</h4>
                    <div id="changedFiles"></div>
                </div>
            </div>

            <div id="contentArea" style="background: rgba(10, 22, 40, 0.3); border-radius: 8px; padding: 20px; min-height: 300px; position: relative;">
                <p style="color: var(--text-muted); text-align: center;">
                    Content synchronization active. Open files in your vault to see live collaboration features.
                </p>
            </div>
        </div>

        <div class="activity-feed">
            <div class="panel-title">üì° Live Activity</div>
            <div id="activityFeed">
                <div class="loading">Loading activity...</div>
            </div>
            
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Send a message to the session..." onkeypress="handleMessageKeyPress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let connected = false;
        let eventPollInterval = null;
        let lastEventTime = null;
        let connectedUsers = [];
        let events = [];

        // Connection management
        document.getElementById('connectionForm').onsubmit = function(e) {
            e.preventDefault();
            connectToSession();
        };

        async function connectToSession() {
            const userId = document.getElementById('userId').value.trim();
            const displayName = document.getElementById('displayName').value.trim();
            const role = document.getElementById('userRole').value;

            if (!userId || !displayName || !role) {
                showToast('‚ùå Please fill in all fields', 'error');
                return;
            }

            try {
                updateConnectionStatus('connecting', 'Connecting...');

                // Store user info
                currentUser = { userId, displayName, role };

                // Connect to server
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        display_name: displayName,
                        role: role
                    })
                });

                const result = await response.json();

                if (result.success) {
                    connected = true;
                    updateConnectionStatus('connected', `Connected as ${displayName}`);
                    
                    // Hide connect form, show session interface
                    document.getElementById('connectForm').classList.add('hidden');
                    document.getElementById('sessionInterface').classList.remove('hidden');

                    // Start event polling
                    startEventPolling();
                    
                    showToast(`‚úÖ Connected as ${displayName}`, 'success');
                } else {
                    throw new Error('Connection failed');
                }

            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus('disconnected', 'Connection failed');
                showToast('‚ùå Failed to connect to session', 'error');
            }
        }

        async function disconnect() {
            if (!connected || !currentUser) return;

            try {
                await fetch('/api/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.userId })
                });
            } catch (error) {
                console.error('Disconnect error:', error);
            }

            connected = false;
            stopEventPolling();
            
            // Show connect form, hide session interface
            document.getElementById('connectForm').classList.remove('hidden');
            document.getElementById('sessionInterface').classList.add('hidden');
            
            updateConnectionStatus('disconnected', 'Disconnected');
            showToast('Disconnected from session', 'info');
        }

        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('connectionText');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // Event polling and handling
        function startEventPolling() {
            if (eventPollInterval) return;
            
            eventPollInterval = setInterval(pollForEvents, 2000); // Poll every 2 seconds
            pollForEvents(); // Initial poll
        }

        function stopEventPolling() {
            if (eventPollInterval) {
                clearInterval(eventPollInterval);
                eventPollInterval = null;
            }
        }

        async function pollForEvents() {
            if (!connected || !currentUser) return;

            try {
                const params = new URLSearchParams({
                    user_id: currentUser.userId
                });
                
                if (lastEventTime) {
                    params.set('since', lastEventTime);
                }

                const response = await fetch(`/api/events?${params}`);
                const data = await response.json();

                if (data.events && data.events.length > 0) {
                    data.events.forEach(event => handleEvent(event));
                    lastEventTime = data.server_time;
                }

                // Update server time
                document.getElementById('serverTime').textContent = 
                    new Date(data.server_time).toLocaleTimeString();

                // Update event count
                document.getElementById('eventCount').textContent = events.length;

                // Also poll for users
                await updateUsersList();

            } catch (error) {
                console.error('Event polling error:', error);
                updateConnectionStatus('disconnected', 'Connection lost');
            }
        }

        function handleEvent(event) {
            events.push(event);
            
            // Keep only recent events (last 100)
            if (events.length > 100) {
                events = events.slice(-100);
            }

            // Handle specific event types
            switch (event.event_type) {
                case 'file_changed':
                    handleFileChange(event);
                    break;
                case 'user_joined':
                    handleUserJoined(event);
                    break;
                case 'user_left':
                    handleUserLeft(event);
                    break;
                case 'user_activity':
                    handleUserActivity(event);
                    break;
                case 'message':
                    handleMessage(event);
                    break;
            }

            // Add to activity feed
            addToActivityFeed(event);
        }

        function handleFileChange(event) {
            const fileChangesDiv = document.getElementById('fileChanges');
            const changedFilesDiv = document.getElementById('changedFiles');
            
            // Show file changes section
            fileChangesDiv.style.display = 'block';
            
            // Add changed file
            const fileDiv = document.createElement('div');
            fileDiv.className = 'changed-file';
            fileDiv.innerHTML = `
                üìù ${event.data.file_path} 
                <span style="color: var(--accent-teal);">(${new Date(event.data.modified_time).toLocaleTimeString()})</span>
            `;
            
            changedFilesDiv.insertBefore(fileDiv, changedFilesDiv.firstChild);
            
            // Keep only recent changes
            const changes = changedFilesDiv.children;
            if (changes.length > 5) {
                changedFilesDiv.removeChild(changes[changes.length - 1]);
            }

            document.getElementById('syncStatus').textContent = 'File Updated';
            setTimeout(() => {
                document.getElementById('syncStatus').textContent = 'Synchronized';
            }, 2000);
        }

        function handleUserJoined(event) {
            showToast(`üëã ${event.data.display_name} joined the session`, 'success');
        }

        function handleUserLeft(event) {
            showToast(`üëã ${event.data.display_name} left the session`, 'info');
        }

        function handleUserActivity(event) {
            // Update sync status briefly
            document.getElementById('syncStatus').textContent = 'User Activity';
            setTimeout(() => {
                document.getElementById('syncStatus').textContent = 'Synchronized';
            }, 1000);
        }

        function handleMessage(event) {
            showToast(`üí¨ ${event.user_id}: ${event.data.message}`, 'info');
        }

        async function updateUsersList() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                
                connectedUsers = data.users || [];
                
                const usersListDiv = document.getElementById('usersList');
                document.getElementById('userCount').textContent = connectedUsers.length;
                
                if (connectedUsers.length === 0) {
                    usersListDiv.innerHTML = '<div style="color: var(--text-muted); text-align: center;">No users connected</div>';
                    return;
                }

                usersListDiv.innerHTML = '';
                connectedUsers.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    
                    const lastSeen = new Date(user.last_seen);
                    const now = new Date();
                    const minutesAgo = Math.floor((now - lastSeen) / 60000);
                    const isOnline = minutesAgo < 5;

                    let activityText = '';
                    if (user.current_file) {
                        const fileName = user.current_file.split('/').pop().replace('.md', '');
                        activityText = `üìñ Viewing: ${fileName}`;
                    }

                    userDiv.innerHTML = `
                        <div class="user-name">
                            <span class="status-indicator ${isOnline ? 'status-connected' : 'status-disconnected'}"></span>
                            ${user.display_name}
                            <span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span>
                        </div>
                        <div class="user-details">@${user.user_id}</div>
                        ${activityText ? `<div class="user-activity">${activityText}</div>` : ''}
                    `;
                    
                    usersListDiv.appendChild(userDiv);
                });

            } catch (error) {
                console.error('Error updating users list:', error);
            }
        }

        function addToActivityFeed(event) {
            const feedDiv = document.getElementById('activityFeed');
            
            // Remove loading message if present
            const loading = feedDiv.querySelector('.loading');
            if (loading) loading.remove();

            const activityDiv = document.createElement('div');
            activityDiv.className = `activity-item event-${event.event_type}`;
            
            const timestamp = new Date(event.timestamp).toLocaleTimeString();
            let description = '';

            switch (event.event_type) {
                case 'file_changed':
                    description = `üìù File updated: ${event.data.file_path}`;
                    break;
                case 'user_joined':
                    description = `üëã <span class="activity-user">${event.data.display_name}</span> joined`;
                    break;
                case 'user_left':
                    description = `üëã <span class="activity-user">${event.data.display_name}</span> left`;
                    break;
                case 'user_activity':
                    if (event.data.current_file) {
                        const fileName = event.data.current_file.split('/').pop().replace('.md', '');
                        description = `üëÅÔ∏è <span class="activity-user">${event.user_id}</span> viewing ${fileName}`;
                    } else {
                        description = `‚ö° <span class="activity-user">${event.user_id}</span> activity`;
                    }
                    break;
                case 'message':
                    description = `üí¨ <span class="activity-user">${event.user_id}</span>: ${event.data.message}`;
                    break;
                default:
                    description = `${event.event_type} by <span class="activity-user">${event.user_id}</span>`;
            }

            activityDiv.innerHTML = `
                <div class="activity-time">${timestamp}</div>
                <div class="activity-type">${event.event_type.replace('_', ' ').toUpperCase()}</div>
                <div>${description}</div>
            `;

            feedDiv.insertBefore(activityDiv, feedDiv.firstChild);

            // Keep only recent activities
            const activities = feedDiv.querySelectorAll('.activity-item');
            if (activities.length > 50) {
                feedDiv.removeChild(activities[activities.length - 1]);
            }
        }

        // Messaging
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !connected || !currentUser) return;

            try {
                await fetch('/api/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: 'message',
                        user_id: currentUser.userId,
                        data: {
                            message: message,
                            from_user: currentUser.displayName
                        }
                    })
                });

                messageInput.value = '';
            } catch (error) {
                console.error('Message send error:', error);
                showToast('‚ùå Failed to send message', 'error');
            }
        }

        // Utility functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Simulate user activity tracking
        function trackUserActivity() {
            if (!connected || !currentUser) return;

            const activityData = {
                user_id: currentUser.userId,
                current_file: 'Example Session File.md', // Would be actual file in real implementation
                last_activity: new Date().toISOString()
            };

            fetch('/api/activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activityData)
            }).catch(error => {
                console.error('Activity tracking error:', error);
            });
        }

        // Track activity periodically
        setInterval(trackUserActivity, 30000); // Every 30 seconds

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (connected && currentUser) {
                navigator.sendBeacon('/api/disconnect', JSON.stringify({
                    user_id: currentUser.userId
                }));
            }
        });
    </script>
</body>
</html>