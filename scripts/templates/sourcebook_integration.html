
<!-- D&D Sourcebook Integration Multi-Select -->
<div class="sourcebook-integration-section">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card card-fantasy mb-4">
                    <div class="card-header">
                        <h3><i class="fas fa-dragon me-2"></i>D&D 5e Sourcebook Integration</h3>
                        <p class="mb-0">Select official D&D sourcebooks to integrate with your Cordelia campaign</p>
                    </div>
                    <div class="card-body">
                        <div class="sourcebook-grid">

                            <div class="sourcebook-category mb-4">
                                <h4 class="text-primary mb-3">ðŸ“š Campaign Books</h4>
                                <div class="row">

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_curse_of_strahd"
                                                       name="sourcebooks" 
                                                       value="curse_of_strahd">
                                                <label class="form-check-label w-100" 
                                                       for="book_curse_of_strahd">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Curse of Strahd</h6>
                                                        <small class="text-muted">(CoS) â€¢ Levels 1-10</small>
                                                        <p class="small mt-1 mb-2">Gothic horror campaign in Barovia</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">horror</span> <span class="badge bg-secondary me-1">undead</span> <span class="badge bg-secondary me-1">gothic</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_tomb_of_annihilation"
                                                       name="sourcebooks" 
                                                       value="tomb_of_annihilation">
                                                <label class="form-check-label w-100" 
                                                       for="book_tomb_of_annihilation">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Tomb of Annihilation</h6>
                                                        <small class="text-muted">(ToA) â€¢ Levels 1-11</small>
                                                        <p class="small mt-1 mb-2">Jungle exploration and dungeon crawl in Chult</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">exploration</span> <span class="badge bg-secondary me-1">jungle</span> <span class="badge bg-secondary me-1">undead</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_waterdeep_dragon_heist"
                                                       name="sourcebooks" 
                                                       value="waterdeep_dragon_heist">
                                                <label class="form-check-label w-100" 
                                                       for="book_waterdeep_dragon_heist">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Waterdeep: Dragon Heist</h6>
                                                        <small class="text-muted">(WDH) â€¢ Levels 1-5</small>
                                                        <p class="small mt-1 mb-2">Urban intrigue and heist adventure</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">urban</span> <span class="badge bg-secondary me-1">intrigue</span> <span class="badge bg-secondary me-1">crime</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_waterdeep_dungeon_of_the_mad_mage"
                                                       name="sourcebooks" 
                                                       value="waterdeep_dungeon_of_the_mad_mage">
                                                <label class="form-check-label w-100" 
                                                       for="book_waterdeep_dungeon_of_the_mad_mage">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Waterdeep: Dungeon of the Mad Mage</h6>
                                                        <small class="text-muted">(WDMM) â€¢ Levels 5-20</small>
                                                        <p class="small mt-1 mb-2">Mega-dungeon beneath Waterdeep</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">dungeon</span> <span class="badge bg-secondary me-1">magic</span> <span class="badge bg-secondary me-1">exploration</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_ghosts_of_saltmarsh"
                                                       name="sourcebooks" 
                                                       value="ghosts_of_saltmarsh">
                                                <label class="form-check-label w-100" 
                                                       for="book_ghosts_of_saltmarsh">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Ghosts of Saltmarsh</h6>
                                                        <small class="text-muted">(GoS) â€¢ Levels 1-12</small>
                                                        <p class="small mt-1 mb-2">Maritime adventures and sea-based campaigns</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">nautical</span> <span class="badge bg-secondary me-1">pirates</span> <span class="badge bg-secondary me-1">coastal</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_baldur's_gate_descent_into_avernus"
                                                       name="sourcebooks" 
                                                       value="baldur's_gate_descent_into_avernus">
                                                <label class="form-check-label w-100" 
                                                       for="book_baldur's_gate_descent_into_avernus">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Baldur's Gate: Descent into Avernus</h6>
                                                        <small class="text-muted">(DiA) â€¢ Levels 1-13</small>
                                                        <p class="small mt-1 mb-2">Planar adventure through the Nine Hells</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">planar</span> <span class="badge bg-secondary me-1">devils</span> <span class="badge bg-secondary me-1">redemption</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_icewind_dale_rime_of_the_frostmaiden"
                                                       name="sourcebooks" 
                                                       value="icewind_dale_rime_of_the_frostmaiden">
                                                <label class="form-check-label w-100" 
                                                       for="book_icewind_dale_rime_of_the_frostmaiden">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Icewind Dale: Rime of the Frostmaiden</h6>
                                                        <small class="text-muted">(RotFM) â€¢ Levels 1-12</small>
                                                        <p class="small mt-1 mb-2">Arctic horror and survival adventure</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">arctic</span> <span class="badge bg-secondary me-1">horror</span> <span class="badge bg-secondary me-1">survival</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_the_wild_beyond_the_witchlight"
                                                       name="sourcebooks" 
                                                       value="the_wild_beyond_the_witchlight">
                                                <label class="form-check-label w-100" 
                                                       for="book_the_wild_beyond_the_witchlight">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">The Wild Beyond the Witchlight</h6>
                                                        <small class="text-muted">(WBtW) â€¢ Levels 1-8</small>
                                                        <p class="small mt-1 mb-2">Feywild carnival and fey adventure</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">fey</span> <span class="badge bg-secondary me-1">carnival</span> <span class="badge bg-secondary me-1">whimsical</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_call_of_the_netherdeep"
                                                       name="sourcebooks" 
                                                       value="call_of_the_netherdeep">
                                                <label class="form-check-label w-100" 
                                                       for="book_call_of_the_netherdeep">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Call of the Netherdeep</h6>
                                                        <small class="text-muted">(CoN) â€¢ Levels 3-12</small>
                                                        <p class="small mt-1 mb-2">Epic multi-continental Critical Role campaign</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">epic</span> <span class="badge bg-secondary me-1">multiverse</span> <span class="badge bg-secondary me-1">ancient</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            
                            <div class="sourcebook-category">
                                <h4 class="text-success mb-3">ðŸ“– Adventure Collections</h4>
                                <div class="row">

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_candlekeep_mysteries"
                                                       name="sourcebooks" 
                                                       value="candlekeep_mysteries">
                                                <label class="form-check-label w-100" 
                                                       for="book_candlekeep_mysteries">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Candlekeep Mysteries</h6>
                                                        <small class="text-muted">(CM) â€¢ Levels 1-16</small>
                                                        <p class="small mt-1 mb-2">Collection of book-based mystery adventures</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">mystery</span> <span class="badge bg-secondary me-1">investigation</span> <span class="badge bg-secondary me-1">magic</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_journeys_through_the_radiant_citadel"
                                                       name="sourcebooks" 
                                                       value="journeys_through_the_radiant_citadel">
                                                <label class="form-check-label w-100" 
                                                       for="book_journeys_through_the_radiant_citadel">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Journeys through the Radiant Citadel</h6>
                                                        <small class="text-muted">(JttRC) â€¢ Levels 1-14</small>
                                                        <p class="small mt-1 mb-2">Anthology of culturally diverse adventures</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">diverse</span> <span class="badge bg-secondary me-1">cultural</span> <span class="badge bg-secondary me-1">anthology</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_dragons_of_stormwreck_isle"
                                                       name="sourcebooks" 
                                                       value="dragons_of_stormwreck_isle">
                                                <label class="form-check-label w-100" 
                                                       for="book_dragons_of_stormwreck_isle">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Dragons of Stormwreck Isle</h6>
                                                        <small class="text-muted">(DoSI) â€¢ Levels 1-3</small>
                                                        <p class="small mt-1 mb-2">Beginner-friendly dragon adventure</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">dragons</span> <span class="badge bg-secondary me-1">beginner</span> <span class="badge bg-secondary me-1">island</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="sourcebook-option">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="book_keys_from_the_golden_vault"
                                                       name="sourcebooks" 
                                                       value="keys_from_the_golden_vault">
                                                <label class="form-check-label w-100" 
                                                       for="book_keys_from_the_golden_vault">
                                                    <div class="sourcebook-card">
                                                        <h6 class="mb-1">Keys from the Golden Vault</h6>
                                                        <small class="text-muted">(KftGV) â€¢ Levels 1-11</small>
                                                        <p class="small mt-1 mb-2">Heist-themed adventure anthology</p>
                                                        <div class="theme-tags"><span class="badge bg-secondary me-1">heist</span> <span class="badge bg-secondary me-1">crime</span> <span class="badge bg-secondary me-1">stealth</span></div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        
                        <div class="integration-controls mt-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <button class="btn btn-primary me-2" onclick="integrateSelectedBooks()">
                                        <i class="fas fa-download me-1"></i>Integrate Selected Books
                                    </button>
                                    <button class="btn btn-outline-secondary me-2" onclick="selectAllBooks()">
                                        <i class="fas fa-check-double me-1"></i>Select All
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearSelection()">
                                        <i class="fas fa-times me-1"></i>Clear Selection
                                    </button>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-muted">
                                        <span id="selected-count">0</span> of <span id="total-count">{len(self.sourcebooks)}</span> selected
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sourcebook-option {
    height: 100%;
}

.sourcebook-card {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    height: 100%;
    transition: all 0.2s;
    background: white;
}

.sourcebook-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.form-check-input:checked ~ .form-check-label .sourcebook-card {
    border-color: #0d6efd;
    background: #f8f9ff;
}

.theme-tags {
    margin-top: 0.5rem;
}

.theme-tags .badge {
    font-size: 0.7em;
}

.sourcebook-grid {
    max-height: 600px;
    overflow-y: auto;
}

.integration-controls {
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}
</style>

<script>
let selectedBooks = new Set();

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedBooks.size;
}

function selectAllBooks() {
    document.querySelectorAll('input[name="sourcebooks"]').forEach(checkbox => {
        checkbox.checked = true;
        selectedBooks.add(checkbox.value);
    });
    updateSelectedCount();
}

function clearSelection() {
    document.querySelectorAll('input[name="sourcebooks"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    selectedBooks.clear();
    updateSelectedCount();
}

function integrateSelectedBooks() {
    const selected = Array.from(document.querySelectorAll('input[name="sourcebooks"]:checked'))
                          .map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Please select at least one sourcebook to integrate.');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Integrating...';
    button.disabled = true;
    
    // Simulate integration process
    fetch('/api/integrate-sourcebooks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({sourcebooks: selected})
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.success) {
            alert(`Successfully initiated integration for ${selected.length} sourcebook(s). Check the integration dashboard for progress.`);
            // Optionally redirect to integration dashboard
            window.location.href = '/dashboard';
        } else {
            alert('Integration failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Integration failed: ' + error.message);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('total-count').textContent = document.querySelectorAll('input[name="sourcebooks"]').length;
    
    // Add event listeners to checkboxes
    document.querySelectorAll('input[name="sourcebooks"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedBooks.add(this.value);
            } else {
                selectedBooks.delete(this.value);
            }
            updateSelectedCount();
        });
    });
});
</script>
