<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cordelia Vault - Chat System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #8b4513);
            color: #fff;
            overflow: hidden;
        }
        
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
        }
        
        .sidebar {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-header h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a90e2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .user-name {
            font-weight: bold;
        }
        
        .user-role {
            font-size: 12px;
            color: #ddd;
        }
        
        .thread-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .thread-section {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-header {
            padding: 15px 20px 10px;
            font-weight: bold;
            font-size: 14px;
            color: #ddd;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .thread-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }
        
        .thread-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .thread-item.active {
            background: rgba(74, 144, 226, 0.3);
            border-left-color: #4a90e2;
        }
        
        .thread-title {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .thread-meta {
            font-size: 12px;
            color: #ccc;
            display: flex;
            justify-content: space-between;
        }
        
        .thread-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .main-chat {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chat-header {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .thread-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        
        .thread-file {
            font-size: 14px;
            color: #ddd;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .chat-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .chat-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .message-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: 12px;
            border-top-left-radius: 4px;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .message-author {
            font-weight: bold;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 12px;
            color: #ccc;
        }
        
        .message-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
        }
        
        .message-text {
            line-height: 1.4;
            font-size: 14px;
        }
        
        .message-reactions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .reaction {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .reaction:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .system-message {
            text-align: center;
            color: #ccc;
            font-style: italic;
            font-size: 13px;
            margin: 10px 0;
        }
        
        .input-area {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            resize: none;
            max-height: 100px;
            min-height: 44px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #4a90e2;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .message-input::placeholder {
            color: #ccc;
        }
        
        .send-button {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .send-button:hover {
            background: #357abd;
        }
        
        .send-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ccc;
            text-align: center;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #fff;
        }
        
        .create-thread-button {
            margin-top: 20px;
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .create-thread-button:hover {
            background: #357abd;
        }
        
        /* Modal styles for creating threads */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal h3 {
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background: #4a90e2;
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>💬 Vault Chat</h2>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">🎲</div>
                    <div>
                        <div class="user-name" id="userName">Game Master</div>
                        <div class="user-role" id="userRole">GM</div>
                    </div>
                </div>
            </div>
            
            <div class="thread-list">
                <div class="thread-section">
                    <div class="section-header">Active Discussions</div>
                    <div id="activeThreads">
                        <!-- Active threads will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-chat">
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="thread-info">
                    <h3 id="threadTitle">Thread Title</h3>
                    <div class="thread-file" id="threadFile">Associated File</div>
                </div>
                <div class="chat-actions">
                    <button onclick="searchThread()">🔍 Search</button>
                    <button onclick="exportThread()">📤 Export</button>
                    <button onclick="closeThread()">❌ Close</button>
                </div>
            </div>
            
            <div class="messages-area" id="messagesArea">
                <div class="empty-state">
                    <h3>Welcome to Vault Chat!</h3>
                    <p>Select a discussion thread from the sidebar or create a new one to get started.</p>
                    <p>Use this system to discuss content with your players, ask questions about NPCs, or coordinate session planning.</p>
                    <button class="create-thread-button" onclick="showCreateThreadModal()">+ Create New Thread</button>
                </div>
            </div>
            
            <div class="input-area" id="inputArea" style="display: none;">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="Type your message..."
                        onkeydown="handleKeyDown(event)"></textarea>
                    <button class="send-button" onclick="sendMessage()">📤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Thread Modal -->
    <div id="createThreadModal" class="modal">
        <div class="modal-content">
            <h3>Create New Discussion Thread</h3>
            <form id="createThreadForm">
                <div class="form-group">
                    <label for="threadTitleInput">Thread Title</label>
                    <input type="text" id="threadTitleInput" required>
                </div>
                <div class="form-group">
                    <label for="threadFileInput">Associated File</label>
                    <select id="threadFileInput" required>
                        <option value="">Select a file...</option>
                        <option value="Queen Seraphina Lumengarde.md">Queen Seraphina Lumengarde.md</option>
                        <option value="The Shadow Conspiracy.md">The Shadow Conspiracy.md</option>
                        <option value="Vex Shadowthorn.md">Vex Shadowthorn.md</option>
                        <option value="Aquabyssos Overview.md">Aquabyssos Overview.md</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="threadDescInput">Description (Optional)</label>
                    <textarea id="threadDescInput" placeholder="Describe what this thread is for..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="hideCreateThreadModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Create Thread</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Mock data for demonstration
        let currentUser = 'gm';
        let currentThread = null;
        
        const mockUsers = {
            'gm': { display_name: 'Game Master', role: 'GM', avatar: '🎲', color: '#ff6b6b' },
            'alice': { display_name: 'Alice', role: 'Player', avatar: '🧙‍♀️', color: '#4a90e2' },
            'bob': { display_name: 'Bob', role: 'Player', avatar: '⚔️', color: '#50e3c2' },
            'carol': { display_name: 'Carol', role: 'Player', avatar: '🏹', color: '#f5a623' }
        };
        
        let mockThreads = {
            'thread_001': {
                id: 'thread_001',
                title: 'Queen Seraphina\'s Corruption',
                file_path: 'Queen Seraphina Lumengarde.md',
                creator: 'gm',
                description: 'Discussion about the queen\'s crystal corruption arc',
                participants: ['gm', 'alice', 'bob'],
                message_count: 12,
                last_activity: '2025-08-13T15:30:00',
                status: 'active'
            },
            'thread_002': {
                id: 'thread_002',
                title: 'Shadow Conspiracy Investigation',
                file_path: 'The Shadow Conspiracy.md',
                creator: 'alice',
                description: 'Planning our investigation approach',
                participants: ['gm', 'alice', 'bob', 'carol'],
                message_count: 8,
                last_activity: '2025-08-13T14:15:00',
                status: 'active'
            }
        };
        
        let mockMessages = {
            'thread_001': [
                {
                    id: 'msg_001',
                    user: 'gm',
                    content: 'I\'m thinking about how to reveal the queen\'s corruption slowly. Maybe through behavioral changes first?',
                    timestamp: '2025-08-13T15:00:00',
                    reactions: { '👍': ['alice', 'bob'], '🤔': ['carol'] }
                },
                {
                    id: 'msg_002',
                    user: 'alice',
                    content: 'That sounds great! Maybe she could start making decisions that seem slightly off?',
                    timestamp: '2025-08-13T15:05:00',
                    reactions: {}
                },
                {
                    id: 'msg_003',
                    user: 'bob',
                    content: 'What if NPCs start commenting on changes in her appearance? Like crystalline growths?',
                    timestamp: '2025-08-13T15:30:00',
                    reactions: { '💡': ['gm', 'alice'] }
                }
            ],
            'thread_002': [
                {
                    id: 'msg_004',
                    user: 'alice',
                    content: 'Should we investigate the surgical facilities first or try to infiltrate the shadow network?',
                    timestamp: '2025-08-13T14:00:00',
                    reactions: {}
                },
                {
                    id: 'msg_005',
                    user: 'gm',
                    content: 'Both approaches have merits. The surgical facilities might have more concrete evidence.',
                    timestamp: '2025-08-13T14:15:00',
                    reactions: { '🎯': ['alice', 'bob'] }
                }
            ]
        };

        function initializeChat() {
            populateThreadList();
            updateUserInfo();
        }

        function updateUserInfo() {
            const user = mockUsers[currentUser];
            document.getElementById('userAvatar').textContent = user.avatar;
            document.getElementById('userName').textContent = user.display_name;
            document.getElementById('userRole').textContent = user.role;
        }

        function populateThreadList() {
            const container = document.getElementById('activeThreads');
            container.innerHTML = '';

            for (const thread of Object.values(mockThreads)) {
                const threadEl = document.createElement('div');
                threadEl.className = 'thread-item';
                threadEl.onclick = () => selectThread(thread.id);
                
                const timeAgo = formatTimeAgo(thread.last_activity);
                
                threadEl.innerHTML = `
                    <div class="thread-title">${thread.title}</div>
                    <div class="thread-meta">
                        <span>${timeAgo}</span>
                        <span class="thread-count">${thread.message_count}</span>
                    </div>
                `;

                container.appendChild(threadEl);
            }
        }

        function selectThread(threadId) {
            currentThread = threadId;
            const thread = mockThreads[threadId];
            
            // Update active thread in sidebar
            document.querySelectorAll('.thread-item').forEach(el => {
                el.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Show chat header and input
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('inputArea').style.display = 'block';
            
            // Update thread info
            document.getElementById('threadTitle').textContent = thread.title;
            document.getElementById('threadFile').textContent = thread.file_path;
            
            // Load messages
            loadMessages(threadId);
        }

        function loadMessages(threadId) {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            
            const messages = mockMessages[threadId] || [];
            
            for (const message of messages) {
                const messageEl = createMessageElement(message);
                messagesArea.appendChild(messageEl);
            }
            
            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function createMessageElement(message) {
            const user = mockUsers[message.user];
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Create reactions HTML
            let reactionsHTML = '';
            if (Object.keys(message.reactions).length > 0) {
                reactionsHTML = '<div class="message-reactions">';
                for (const [emoji, users] of Object.entries(message.reactions)) {
                    reactionsHTML += `
                        <div class="reaction" onclick="toggleReaction('${message.id}', '${emoji}')">
                            ${emoji} ${users.length}
                        </div>
                    `;
                }
                reactionsHTML += '</div>';
            }
            
            messageEl.innerHTML = `
                <div class="message-avatar" style="background: ${user.color};">
                    ${user.avatar}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${user.display_name}</span>
                        <span class="message-role">${user.role}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${message.content}</div>
                    ${reactionsHTML}
                </div>
            `;
            
            return messageEl;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentThread) return;
            
            // Create new message
            const newMessage = {
                id: `msg_${Date.now()}`,
                user: currentUser,
                content: content,
                timestamp: new Date().toISOString(),
                reactions: {}
            };
            
            // Add to mock data
            if (!mockMessages[currentThread]) {
                mockMessages[currentThread] = [];
            }
            mockMessages[currentThread].push(newMessage);
            
            // Update thread message count
            mockThreads[currentThread].message_count++;
            mockThreads[currentThread].last_activity = newMessage.timestamp;
            
            // Clear input and reload
            input.value = '';
            loadMessages(currentThread);
            populateThreadList();
        }

        function toggleReaction(messageId, emoji) {
            // Find message and toggle reaction
            for (const messages of Object.values(mockMessages)) {
                for (const message of messages) {
                    if (message.id === messageId) {
                        if (!message.reactions[emoji]) {
                            message.reactions[emoji] = [];
                        }
                        
                        const userIndex = message.reactions[emoji].indexOf(currentUser);
                        if (userIndex > -1) {
                            message.reactions[emoji].splice(userIndex, 1);
                            if (message.reactions[emoji].length === 0) {
                                delete message.reactions[emoji];
                            }
                        } else {
                            message.reactions[emoji].push(currentUser);
                        }
                        
                        loadMessages(currentThread);
                        return;
                    }
                }
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showCreateThreadModal() {
            document.getElementById('createThreadModal').style.display = 'block';
        }

        function hideCreateThreadModal() {
            document.getElementById('createThreadModal').style.display = 'none';
            document.getElementById('createThreadForm').reset();
        }

        function createThread() {
            const title = document.getElementById('threadTitleInput').value.trim();
            const file = document.getElementById('threadFileInput').value;
            const description = document.getElementById('threadDescInput').value.trim();
            
            if (!title || !file) {
                alert('Please fill in required fields');
                return;
            }
            
            const threadId = `thread_${Date.now()}`;
            
            mockThreads[threadId] = {
                id: threadId,
                title: title,
                file_path: file,
                creator: currentUser,
                description: description,
                participants: [currentUser],
                message_count: 0,
                last_activity: new Date().toISOString(),
                status: 'active'
            };
            
            mockMessages[threadId] = [];
            
            hideCreateThreadModal();
            populateThreadList();
            selectThread(threadId);
        }

        function searchThread() {
            const query = prompt('Search messages in this thread:');
            if (query) {
                alert(`Searching for: "${query}" (demo mode)`);
            }
        }

        function exportThread() {
            if (currentThread) {
                const thread = mockThreads[currentThread];
                alert(`Exporting thread: "${thread.title}" (demo mode)`);
            }
        }

        function closeThread() {
            currentThread = null;
            document.getElementById('chatHeader').style.display = 'none';
            document.getElementById('inputArea').style.display = 'none';
            document.getElementById('messagesArea').innerHTML = `
                <div class="empty-state">
                    <h3>Welcome to Vault Chat!</h3>
                    <p>Select a discussion thread from the sidebar or create a new one to get started.</p>
                    <p>Use this system to discuss content with your players, ask questions about NPCs, or coordinate session planning.</p>
                    <button class="create-thread-button" onclick="showCreateThreadModal()">+ Create New Thread</button>
                </div>
            `;
            
            document.querySelectorAll('.thread-item').forEach(el => {
                el.classList.remove('active');
            });
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return `${Math.floor(diffMins / 1440)}d ago`;
        }

        // Event listeners
        document.getElementById('createThreadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createThread();
        });

        // Close modal when clicking outside
        document.getElementById('createThreadModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCreateThreadModal();
            }
        });

        // Initialize on load
        window.addEventListener('load', initializeChat);
    </script>
</body>
</html>